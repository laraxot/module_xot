<?php

declare(strict_types=1);

namespace Modules\Xot\Services;

use Cache;
use Exception;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Str;
use ImageOptimizer;
use Intervention\Image\Image;

//---- services ----

/**
 * Class ImageService.
 */
class ImageService {
    private static ?self $instance = null;

    protected  ?Image $img = null;

    protected  int $width;

    protected  int $height;

    protected  string $src;

    protected  string $filename;

    protected  string $dirname = '/imgz';

    public static function getInstance(): self {
        if (null === self::$instance) {
            self::$instance = new self();
        }

        return self::$instance;
    }

    public static function make(): self {
        return static::getInstance();
    }

    /**
     * ImageService constructor.
     */
    public function __construct(/*array $params = []*/) {
        //$this->init($params);
    }

    //---- setter

    public function init(array $params): self {

        foreach ($params as $k => $v) {
            $func = 'set'.Str::studly((string) $k);
            if (null == $v) {
                $v = '';
            }
            //if (method_exists($instance, $func)) {
            $this->{$func}($v);
            //} else {
            //    self::$k = $v;
            // }
        }
        return $this;
    }

    public  function setDirname(string $dirname): void {
        self::$dirname = $dirname;
    }

    /**
     * Undocumented function.
     *
     * @return mixed
     */
    public function getImg() {
        return $this->img;
    }

    public  function setImg(string $val): void {
        $nophoto_path = public_path('img/nophoto.jpg');
        if ('' == $val) {
            $val = $nophoto_path;
        }
        if (Str::startsWith($val, '//')) {
            $val = 'http:'.$val;
        }
        if (Str::startsWith($val, '/photos/')) {
            $val = public_path($val);
        }
        try {
            $this->img = Image::make($val);
        } catch (\Exception $e) {
            $this->img = Image::make($nophoto_path);
        }
    }

    public  function setWxh(string $val): void {
        list($w, $h) = \explode('x', $val);
        self::setWidth((int) $w);
        self::setHeight((int) $h);
    }

    public  function setWidth(int $val): void {
        $this->width = $val;
    }

    public  function setHeight(int $val): void {
        $this->height = $val;
    }

    public  function setSrc(string $val): void {
        if ('' == $val) {
            $val = public_path('img/nophoto.jpg');
        }
        if (Str::startsWith($val, url(''))) { //se e' una immagine locale
            $val = public_path(\substr($val, strlen(url(''))));
        }
        $str = '/laravel-filemanager/';
        if (Str::startsWith($val, $str)) {
            $val = public_path(\substr($val, strlen($str)));
        }
        self::$src = $val;
        self::setImg($val);
    }

    //----------

    /**
     * Undocumented function.
     *
     * @return mixed
     */
    public  function toHtml() {
    }

    /**
     * @return mixed
     */
    public  function image_resized_cropped(array $params) {
        $width = $this->width;
        $height = $this->height;
        \extract($params);
        if (! isset($image_path)) {
            dddx(['err' => 'image_path is missing']);

            return;
        }
        $pathinfo = \pathinfo($image_path);
        //$image_resized='assets_packs/img/'.$width.'x'.$height.'/'.basename($image_path);
        if (null == $image_path) {
            return 'assets_packs/img/'.$width.'x'.$height.'/nophoto.png';
        }
        $image_resized = 'assets_packs/img/'.$width.'x'.$height.'/'.$pathinfo['filename'].'.jpg';
        if (\File::exists(public_path($image_resized))) {
            return $image_resized;
        } //immagine la creo 1 volta sola
        if ('//' == \mb_substr($image_path, 0, 2)) {
            $image_path = 'http:'.$image_path;
        }



        $allowedMimeTypes = ['image/jpeg', 'image/gif', 'image/png', 'image/bmp', 'image/svg+xml'];
        $allowedExtensions = ['jpg', 'png', 'gif'];
        if (! isset($pathinfo['extension'])) {
            return $image_path;
        }
        if (! \in_array($pathinfo['extension'], $allowedExtensions, true)) {
            return $image_path;
        }

        $img = Image::make($image_path);

        $img->resize(
            $width, null, function ($constraint): void {
                $constraint->aspectRatio();
            }
        );

        if ($img->height() > $height) {

            $x0 = 0;
            $y0 = \rand(0, $img->height() - $height);
            $img->crop($width, $height, $x0, $y0);
        }
        $w0 = $img->width();
        $h0 = $img->height();
        $canvas = Image::canvas($width, $height, '#fdfdfd');
        $x = \round(($width - $w0) / 2, 0);
        $y = \round(($height - $h0) / 2, 0);
        $canvas->insert($img, 'top-left', (int) $x, (int) $y);

        \File::makeDirectory(\dirname(public_path($image_resized)), 0775, true, true);
        $canvas->save(public_path($image_resized), 75);
        //ImageOptimizer::optimize(public_path($image_resized));
        //app(Spatie\ImageOptimizer\OptimizerChain::class)->optimize(public_path($image_resized));
        return $image_resized;
    }


    public  function fit(array $params = []): self {
        $img = $this->img;
        $width = $this->width;
        $height = $this->height;

        $this->img->fit($width, $height);
        return $this;
    }
    /*
    public  function crop(array $params = []): self {

        $img = $this->img;
        $width = $this->width;
        $height = $this->height;

        if ($width > $height) {
            $img->resize(
                $width, null, function ($constraint): void {
                    $constraint->aspectRatio();
                }
            );

            if ($img->height() > $height) {

                $x0 = 0;
                $y0 = round(($img->height() + $height) / 2, 0);
                $img->crop($width, $height, $x0, $y0);
            }
        } else {
            $img->resize(
                null, $height, function ($constraint): void {
                    $constraint->aspectRatio();
                }
            );

            if ($img->width() > $width) {

                $x0 = round(($img->width() + $width) / 2, 0);
                $y0 = 0;
                $img->crop($width, $height, $x0, $y0);
            }
        }
        $w0 = $img->width();
        $h0 = $img->height();
        $canvas = Image::canvas($width, $height, '#fdfdfd');
        $x = \round(($width - $w0) / 2, 0);
        $y = \round(($height - $h0) / 2, 0);
        $canvas->insert($img, 'top-left', (int) $x, (int) $y);
        $this->img = $canvas;
        return $this;
    }
    */

    public url(array $params = []): string {
        $img = \Modules\Xot\Models\Image::where('src', self::$src)
            ->where('width', $this->width)
            ->where('height', $this->height)
            ->first();

        if (is_object($img)) {
            if (null == $img->src_out) {
                throw new \Exception('$img->src_out==null ['.__LINE__.']['.__FILE__.']');
            }
            if (Str::startsWith($img->src_out, Storage::disk('photos')->url(''))) {
                $out = str_replace('http://', '//', $img->src_out);
                if (! is_string($out)) {
                    throw new \Exception('out is not a string');
                }

                return $out;
            } else {
                $img->delete();
            }
        }

        $this->fit()->save();
        $src_out = Storage::disk('photos')->url(self::$filename);

        \Modules\Xot\Models\Image::create(
            [
                'src' => self::$src,
                'width' => $this->width,
                'height' => $this->height,
                'src_out' => $src_out,
            ]
        );

        return $src_out;
    }

    public function save(array $params = []): self {
        $info = pathinfo(self::$src);
        if (! isset($info['extension'])) {
            $info['extension'] = 'jpg';
        }

        $basename = Str::slug($info['filename']).'.'.$info['extension'];

        self::$filename = self::$dirname.'/'.$this->width.'x'.$this->height.'/'.$basename;


        try {
            Storage::disk('photos')->put(self::$filename, self::out());
        } catch (\Exception $e) {//ftp_mkdir(): Can't create directory: File exists
             //$r = $this->img->save(self::$filename, 75);
        }

        $me = self::getInstance();
        if (null == $me) {
            throw new Exception('something gone wrong');
        }

        return $me;
    }

    /**
     * @return string
     */
    public function out(array $params = []) {
        return $this->img->encode('jpg', 60);
    }

    public function src(array $params = []) :string{
        $src = '/'.str_replace(public_path('/'), '', self::$filename);
        $src = str_replace('//', '/', $src);

        return $src;
    }

    public function image_resized_canvas(array $params):string {
        $width = $this->width;
        $height = $this->height;
        \extract($params);
        if (! isset($image_path)) {
            dddx(['err' => 'image_path is missing']);

            return;
        }
        $pathinfo = \pathinfo($image_path);
        //$image_resized='assets_packs/img/'.$width.'x'.$height.'/'.basename($image_path);
        if (null == $image_path) {
            //return 'assets_packs/img/'.$width.'x'.$height.'/nophoto.png';
            $image_path = public_path('images/nophoto.png');
        }
        $image_resized = 'assets_packs/img/'.$width.'x'.$height.'/'.$pathinfo['filename'].'.jpg';
        //if(\File::exists(public_path($image_resized))) return $image_resized; //immagine la creo 1 volta sola
        if ('//' == \mb_substr($image_path, 0, 2)) {
            $image_path = 'http:'.$image_path;
        }
        $allowedMimeTypes = ['image/jpeg', 'image/gif', 'image/png', 'image/bmp', 'image/svg+xml'];
        $allowedExtensions = ['jpg', 'png', 'gif'];
        if (! isset($pathinfo['extension'])) {
            $pathinfo['extension'] = '';
        }
        $pos = \mb_strpos($pathinfo['extension'], '&');
        if (false !== $pos) {
            $pathinfo['extension'] = \mb_substr($pathinfo['extension'], 0, $pos);
        }

        //429    Offset 'extension' on array{dirname: string, basename: string, filename: string, extension: string} in isset() always exists and is not nullable.
        //if (! isset($pathinfo['extension'])) {
        //    return $image_path;
        //}

        if (! \in_array($pathinfo['extension'], $allowedExtensions, true)) {
            return $image_path;
        }
        //if(!in_array($contentType,$allowedMimeTypes)) return $image_path;
        //* -- spostato in importtrait
        $str0 = 'https://s2.qwant.com'; //questo fa un redirect
        $str1 = 'http://s2.qwant.com';
        $str2 = 'https://s2.qwant.com'; //questo fa un redirect
        $str3 = 'http://s2.qwant.com';
        if (\mb_substr($image_path, 0, \mb_strlen($str0)) == $str0 || \mb_substr($image_path, 0, \mb_strlen($str1)) == $str1
            || \mb_substr($image_path, 0, \mb_strlen($str2)) == $str2 || \mb_substr($image_path, 0, \mb_strlen($str3)) == $str3
        ) {
            $pos = \mb_strpos($image_path, '?');
            $image_path1 = \mb_substr($image_path, $pos + 1);
            \parse_str($image_path1, $output);
            //echo '<h3>'.$image_path1.'</h3>';
            $image_path = \urldecode($output['u']);
        }
        //*/
        $str = '/laravel-filemanager/';
        if (\mb_substr($image_path, 0, \mb_strlen($str)) == $str) {
            $image_path = public_path(\mb_substr($image_path, \mb_strlen($str)));
            //die($image_path);
        }
        if (Str::startsWith($image_path, '/')) {
            if (! Str::startsWith($image_path, public_path('/'))) {
                $image_path = public_path($image_path);
            }
        }
        //die($image_path);

        //return $image_path;
        try {
            $img = Image::make($image_path);
        } catch (\Intervention\Image\Exception\NotReadableException $e) {
            $filename = Str::slug(\basename($image_path)).'.'.$pathinfo['extension'];
            /*
            if(!\Storage::disk('cache')->exists($filename)){
                \Storage::disk('cache')->put($filename, fopen($image_path, 'r'));
            }

            */
            //$asset = new FileAsset();

            //$jpg=imagecreatefromjpeg($image_path);

            //die('['.__LINE__.']['.__FILE__.']');
            $img_content = ImportService::cacheRequestFile('GET', $image_path);
            \Storage::disk('cache')->put($filename, $img_content);
            try {
                $img = Image::make(\Storage::disk('cache')->path($filename));
            } catch (\Intervention\Image\Exception\NotReadableException $e) {
                //echo '<h3>['.__LINE__.']['.__FILE__.']</h3>';
                //$this->image_src=''; //-- meglio non cancellare..
                //$this->image_resize_src=[];
                //$this->save();
                //dddx('non dovrei essere qui');
                return null;
            }
            //$img_content=base64_encode($img_content);
            //$im = imagecreatefromstring($img_content);

            //$img=Image::make($img_content);
            //*
            //echo '<h3>['.__LINE__.']['.__FILE__.']</h3>';
            //return ;
            //echo $content;

            //*/
        }

        $img->resize(
            $width, null, function ($constraint): void {
                $constraint->aspectRatio();
            }
        );

        if ($img->height() > $height) {
            $img->resize(
                null, $height, function ($constraint): void {
                    $constraint->aspectRatio();
                }
            );
        }

        $w0 = $img->width();
        $h0 = $img->height();
        $canvas = Image::canvas($width, $height, '#fdfdfd');
        $x = \round(($width - $w0) / 2, 0);
        $y = \round(($height - $h0) / 2, 0);
        $canvas->insert($img, 'top-left', (int) $x, (int) $y);

        \File::makeDirectory(\dirname(public_path($image_resized)), 0775, true, true);
        $canvas->save(public_path($image_resized), 75);
        //ImageOptimizer::optimize(public_path($image_resized));   //--- CAPIRE SE NE VALE LA PENA
        //app(Spatie\ImageOptimizer\OptimizerChain::class)->optimize(public_path($image_resized));
        return $image_resized;
    }
}
